name: Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Build Base Image
  build-base-image:
    name: Build and Push Base Image
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build and Push Base Image
      working-directory: ./base-image
      run: |
        docker buildx create --use
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --cache-from=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/base-image:cache \
          --cache-to=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/base-image:cache,mode=max \
          -t ${{ secrets.DOCKERHUB_REPO }}/base-image:latest \
          -t ${{ secrets.DOCKERHUB_REPO }}/base-image:v1.0-$(date +%Y%m%d)-${{ github.sha }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/base-image:cache \
          --push .

    - name: Scan for Vulnerabilities
      run: |
        docker pull ${{ secrets.DOCKERHUB_REPO }}/base-image:latest
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL ${{ secrets.DOCKERHUB_REPO }}/base-image:latest


  # Job 1.1: Test Base Image
  test-base-image:
    name: Test Base Image
    needs: build-base-image
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Set up Docker Compose for Base Image E2E
      run: docker compose -f ./tests/docker-compose.base.yml up -d
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}

    - name: Run E2E Tests for Base Image
      run: |
        set +e
        docker compose -f ./tests/docker-compose.base.yml up --abort-on-container-exit --exit-code-from base-tests
        exit_code=$?
        if [ $exit_code -ne 0 ]; then
          echo "Base Image E2E tests failed with exit code $exit_code"
          exit $exit_code
        fi
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}

    - name: Clean Up Base Image Containers
      if: always()
      run: docker compose -f ./tests/docker-compose.base.yml down || true
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}


  # Job 2: Build Python Images
  build-python-images:
    name: Build Python ${{ matrix.python_version }} Image
    needs: test-base-image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python_version: ["3.11", "3.12", "3.13"]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build Python Image
      working-directory: ./python-layer
      run: |
        docker buildx create --use
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --cache-from=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/python-${{ matrix.python_version }}:cache \
          --cache-to=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/python-${{ matrix.python_version }}:cache,mode=max \
          --build-arg BASE_IMAGE=${{ secrets.DOCKERHUB_REPO }}/base-image:latest \
          --build-arg PYTHON_VERSION=${{ matrix.python_version }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/python-${{ matrix.python_version }}:latest \
          -t ${{ secrets.DOCKERHUB_REPO }}/python-${{ matrix.python_version }}:v${{ matrix.python_version }}-$(date +%Y%m%d)-${{ github.sha }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/python-${{ matrix.python_version }}:cache \
          --push .

  test-python-images:
    name: Test Python ${{ matrix.python_version }} Image
    needs: build-python-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python_version: ["3.11", "3.12", "3.13"]

    steps:
    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Test Python Image
      run: |
        docker run --rm --entrypoint bash ${{ secrets.DOCKERHUB_REPO }}/python-${{ matrix.python_version }}:latest \
          -c "python --version && pip --version"


  # Job 3: Build Java Images
  build-java-images:
    name: Build Java ${{ matrix.java_version }} Image
    needs: test-base-image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java_version: [11, 17, 21]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build Java Image
      working-directory: ./java-layer
      run: |
        docker buildx create --use
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --cache-from=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/java-${{ matrix.java_version }}:cache \
          --cache-to=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/java-${{ matrix.java_version }}:cache,mode=max \
          --build-arg BASE_IMAGE=${{ secrets.DOCKERHUB_REPO }}/base-image:latest \
          --build-arg JAVA_VERSION=${{ matrix.java_version }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/java-${{ matrix.java_version }}:latest \
          -t ${{ secrets.DOCKERHUB_REPO }}/java-${{ matrix.java_version }}:v${{ matrix.java_version }}-$(date +%Y%m%d)-${{ github.sha }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/java-${{ matrix.java_version }}:cache \
          --push .

  test-java-images:
    name: Test Java ${{ matrix.java_version }} Image
    needs: build-java-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java_version: [11, 17, 21]

    steps:
    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Test Java Image
      run: |
        docker run --rm --entrypoint bash ${{ secrets.DOCKERHUB_REPO }}/java-${{ matrix.java_version }}:latest \
          -c "java -version 2>&1 && javac -version"


  # Job 4: Build Node.js Images
  build-nodejs-images:
    name: Build Node.js ${{ matrix.nodejs_version }} Image
    needs: test-base-image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        nodejs_version: [20, 22, 24]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build Node.js Image
      working-directory: ./nodejs-layer
      run: |
        docker buildx create --use
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --cache-from=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/nodejs-${{ matrix.nodejs_version }}:cache \
          --cache-to=type=registry,ref=${{ secrets.DOCKERHUB_REPO }}/nodejs-${{ matrix.nodejs_version }}:cache,mode=max \
          --build-arg BASE_IMAGE=${{ secrets.DOCKERHUB_REPO }}/base-image:latest \
          --build-arg nodejs_VERSION=${{ matrix.nodejs_version }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/nodejs-${{ matrix.nodejs_version }}:latest \
          -t ${{ secrets.DOCKERHUB_REPO }}/nodejs-${{ matrix.nodejs_version }}:v${{ matrix.nodejs_version }}-$(date +%Y%m%d)-${{ github.sha }} \
          -t ${{ secrets.DOCKERHUB_REPO }}/nodejs-${{ matrix.nodejs_version }}:cache \
          --push .

  test-nodejs-images:
    name: Test Node.js ${{ matrix.nodejs_version }} Image
    needs: build-nodejs-images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        nodejs_version: [20, 22, 24]

    steps:
    - name: Log in to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Test Node.js Image
      run: |
        docker run --rm --entrypoint bash ${{ secrets.DOCKERHUB_REPO }}/nodejs-${{ matrix.nodejs_version }}:latest \
          -c "node --version && npm --version && python3 --version"


  # Job 5: Generate Build Report
  generate-report:
    name: Generate Build Report
    needs: [test-python-images, test-java-images, test-nodejs-images]
    runs-on: ubuntu-latest
    steps:
    - name: Generate Build Report
      run: |
        cat > build-report.md <<'EOF'
        ### Build Report
        **Base**: Ubuntu 24.04 LTS

        | Stack | Versions | Status |
        |-------|----------|--------|
        | Python | 3.11, 3.12, 3.13 | :white_check_mark: |
        | Java | 11, 17, 21 | :white_check_mark: |
        | Node.js | 20, 22, 24 (+ Python 3.12) | :white_check_mark: |

        **Tools**: AWS CLI, Helm, OC (stable), ArgoCD, GitLab Runner v18.9.0, yq
        **Platforms**: linux/amd64, linux/arm64
        EOF

    - name: Post Summary
      run: cat build-report.md >> $GITHUB_STEP_SUMMARY

    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md

    - name: Notify Slack
      if: ${{ env.SLACK_URL != '' }}
      env:
        SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        REPORT=$(cat build-report.md | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "Build Summary Report",
          "attachments": [
            {
              "title": "Build Status",
              "text": "'"$REPORT"'",
              "color": "#36a64f"
            },
            {
              "title": "View Details",
              "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here>"
            }
          ]
        }' ${{ secrets.SLACK_WEBHOOK_URL }}
